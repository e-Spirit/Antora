<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CaaS Platform :: CrownSpirit Documentation</title>
    <link rel="canonical" href="https://e-spirit.github.io/Antora/headless/1.0/CaaS_Platform/CaaS_Platform_Documentation_EN.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
    <link rel="icon" href="../../../_/img/shortcut-icon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://e-spirit.github.io/Antora">CrownSpirit Documentation</a>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Cloud</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Headless</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">E-Commerce</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://e-spirit.github.io/Antora/ecom/1.0/Spryker/index.html">Spryker</a>
            <a class="navbar-item" href="https://e-spirit.github.io/Antora/ecom/1.0/Spartacus/index.html">Spartacus</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">FirstSpirit</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://docs.e-spirit.com/lp/?locale=en&main=firstspirit&sub=editors">Editors</a>
            <a class="navbar-item" href="https://docs.e-spirit.com/lp/?locale=en&main=firstspirit&sub=developers">Developers</a>
            <a class="navbar-item" href="https://docs.e-spirit.com/lp/?locale=en&main=firstspirit&sub=administrators">Administrators</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Crownpeak</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="headless" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Headless</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">CaaS Connect</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../CaaS_Connect/CaaS_Connect_FSM_Documentation_EN.html">Module documentation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../CaaS_Connect/CaaS_Connect_ServerAdministrator_EN.html">Admin Manual</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../CaaS/CaaS_FSM_Documentation_EN.html">Content as a Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="CaaS_Platform_Documentation_EN.html">CaaS Platform</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Navigation Service (FSM)</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../Nav_Service_FSM/index.html">Main Documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../Nav_Service_FSM/chapters/architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../Nav_Service_FSM/chapters/components.html">Components</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../Nav_Service_FSM/chapters/config.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../Nav_Service_FSM/chapters/auth.html">Authentification</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../Nav_Service_FSM/Navigation_Service_Serveradmin_Documentation_EN.html">Admin Manual</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Nav_Service_Platform/documentation.html">Navigation Service (Platform)</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Headless</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../component-b/1.0/index.html">CrownSpirit Documentation</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../component-b/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../dxm/1.0/index.html">DXM</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../dxm/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../ecom/1.0/index.html">E-Commerce</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../ecom/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../cloud/1.0/index.html">FirstSpirit Cloud</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cloud/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../fsxa-pwa/1.3.0/index.html">FSXA-PWA</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../fsxa-pwa/1.3.0/index.html">1.3.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../fsxa-ui/4.1.0/index.html">FSXA-UI</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../fsxa-ui/4.1.0/index.html">4.1.0</a>
        </li>
        <li class="version">
          <a href="../../../fsxa-ui/3.0.0/index.html">3.0.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">Headless</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../component-b/1.0/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Headless</a></li>
    <li><a href="CaaS_Platform_Documentation_EN.html">CaaS Platform</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/pahl-espirit/headless/edit/main/modules/CaaS_Platform/pages/CaaS_Platform_Documentation_EN.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">CaaS Platform</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The CaaS platform is the link between FirstSpirit and the customer&#8217;s end application.
The REST Interface receives information and updates it in the internal persistence layer of the CaaS platform.
An update of data in the customer&#8217;s end application is done by requests to the REST Interface.</p>
</div>
<div class="paragraph">
<p>The CaaS platform includes the following components, which are available as docker containers:</p>
</div>
<div class="paragraph">
<p><strong>REST Interface (<em>caas-rest-api</em>)</strong></p>
</div>
<div class="paragraph">
<p>The REST Interface is used both for transferring and retrieving data to and from the repository.
For this purpose it provides a REST endpoint that can be used by any service.
It also supports authentication and authorization.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Between CaaS version 2.11 and 2.13 (inclusive), the authentication and authorization functionality was provided by a separate Security Proxy.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>CaaS repository (<em>caas-mongo</em>)</strong></p>
</div>
<div class="paragraph">
<p>The CaaS repository is not accessible from the Internet and can be only accessed within the platform via the REST Interface.
It serves as a storage for all project data and internal configuration.</p>
</div>
<div class="paragraph">
<p><strong><em>Deprecated</em>: CaaS Admin Interface  (<em>caas-admin-webapp</em>)</strong></p>
</div>
<div class="paragraph">
<p>The CaaS Admin Interface enables the management of the information transferred to CaaS and provides a simple, web-based administration interface.
To do this, it communicates with the repository via the REST Interface and is accessible via HTTP(S).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Deprecation notice:</strong>
The CaaS Admin Interface is deprecated since version 7.
We highly recommend using a REST client of your choice.</p>
</div>
<div class="paragraph">
<p>The CaaS Admin Interface will be <strong>removed in December 2021</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tech_requirements"><a class="anchor" href="#tech_requirements"></a>Technical requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The operation of the CaaS platform has to be realized with <a href="#install_kub">Kubernetes</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you do not feel able to operate, configure, monitor, and analyze and resolve operating problems of the cluster infrastructure accordingly, we strongly advise against on-premises operation and refer to our SaaS offering.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since the CaaS-platform is delivered as Helm artifact, the Helm client must be available.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is important that Helm is installed in a secure manner.
For more information, refer to the <a href="https://docs.helm.sh/using_helm/#securing-your-helm-installation"><em>Helm Installation Guide</em></a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For system requirements please consult the <a href="CaaS_Platform_Technical_Datasheet_EN.html">technical data sheet</a> of the CaaS platform .</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install_kub"><a class="anchor" href="#install_kub"></a>Installation and configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The setup of the CaaS platform for operation with Kubernetes is done by using <a href="https://docs.helm.sh/">Helm-Charts</a>.
These are part of the delivery and already contain all necessary components.</p>
</div>
<div class="paragraph">
<p>The following subchapters describe the necessary installation and configuration steps.</p>
</div>
<div class="sect2">
<h3 id="_import_of_the_images"><a class="anchor" href="#_import_of_the_images"></a>Import of the images</h3>
<div class="paragraph">
<p>The first step in setting up he CaaS platform for operation with Kubernetes requires the import of the images  into your central Docker registry (e.g. Artifactory).
The images are contained in the file <code>caas-docker-images-{build-version}.zip</code> in the delivery.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The credentials for cluster access to the repository must be known.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The steps necessary for the import can be found in the documentation of the registry you are using.</p>
</div>
</div>
<div class="sect2">
<h3 id="conf_chart"><a class="anchor" href="#conf_chart"></a>Configuration of the Helm chart</h3>
<div class="paragraph">
<p>After the import of the images the configuration of the Helm chart is necessary.
This is part of the delivery and contained in the file <code>caas-{build-version}.tgz</code>.
A <a href="https://docs.helm.sh/chart_template_guide/#values-files">default configuration</a> of the chart is already make in the <code>values.yaml</code> file.
All parameters specified in this <code>values.yaml</code> can be overwritten with a manually created <code>custom-values.yaml</code> by a specific value.</p>
</div>
<div class="sect3">
<h4 id="conf_chart_authentication"><a class="anchor" href="#conf_chart_authentication"></a>Authentication</h4>
<div class="paragraph">
<p>All authentication settings for the communication  with or within the CaaS platform are specified in the <code>credentials</code> block of the <code>custom-values.yaml</code>.
So here you will find user names and default passwords as well as the CaaS Master API Key.
It is strongly recommended to adjust the default passwords and the CaaS Master API Key.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All selected passwords must be alphanumeric.
Otherwise, problems will occur in connection with CaaS.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The CaaS Master API Key is automatically created during the installation of CaaS and thus allows the direct use of the REST Interface.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_caas_repository_caas_mongo"><a class="anchor" href="#_caas_repository_caas_mongo"></a>CaaS repository (caas-mongo)</h4>
<div class="paragraph">
<p>The configuration of the repository includes two parameters:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">storageClass</dt>
<dd>
<p>The possibility of overwriting parameters from the <code>values.yaml</code> file mainly affects the parameter <code>mongo.persistentVolume.storageClass</code>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For performance reasons, we recommend that the underlying MongoDB filesystem is provisioned with XFS.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">clusterKey</dt>
<dd>
<p>For the authentication key of the Mongo Cluster a default configuration is delivered.
The key can be defined in the parameter <code>credentials.clusterKey</code>.
It is strongly recommended that you use the following command to create a new key for productive operation:</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>openssl rand -base64 756</code></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This value may only be changed during the initial installation.
If it is changed at a later time, this can lead to a permanent unavailability of the database, which can only be repaired manually.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_docker_registry"><a class="anchor" href="#_docker_registry"></a>Docker- Registry</h4>
<div class="paragraph">
<p>An adjustment of the parameters <code>imageRegistry</code> and <code>imageCredentials</code> is necessary to configure the used Docker registry.</p>
</div>
<div class="listingblock">
<div class="title">sample configuration in a custom-values.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">imageRegistry: docker.company.com/e-spirit

imageCredentials:
   username: "username"
   password: "special_password"
   registry: docker.company.com
   enabled: true</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="conf_ingress"><a class="anchor" href="#conf_ingress"></a>Ingress Configurations</h4>
<div class="paragraph">
<p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress-Definitions</a> control the incoming traffic to the respective component and are not created by default by the delivery.
The parameters <code>adminWebapp.ingress.enabled</code> and <code>restApi.ingress.enabled</code> allow the ingress configuration for the REST Interface and the CaaS Admin Interface.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Ingress definitions of the Helm chart assume the <a href="https://github.com/kubernetes/ingress-nginx">NGINX Ingress Controller</a> to be used, since annotations of this concrete implementation are used.
If you are using a different implementation, you must adapt the annotations of the Ingress definitions in your <code>custom-values.yaml</code> file accordingly.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">ingress creation in a custom-values.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">adminWebapp:
   ingress:
      enabled: true
      hosts:
         - caas-webapp.company.com

restApi:
   ingress:
      enabled: true
      hosts:
         - caas.company.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the setting options are not sufficient for the specific application, the Ingress can also be generated independently.
In this case the corresponding parameter must be set to the value <code>enabled: false</code>.
The following code example provides an orientation for the definition.</p>
</div>
<div class="listingblock">
<div class="title">Ingress definition for the REST Interface</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: extensions/v1beta1
child: Ingress
metadata:
   labels:
   name: caas
spec:
   rules:
      - http:
      paths:
      - baking:
         serviceName: caas-rest-api
         servicePort: 80
   host: caas-rest-api.mydomain.com</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="chartinstall"><a class="anchor" href="#chartinstall"></a>Installation of the Helm-Chart</h3>
<div class="paragraph">
<p>After the <a href="#conf_chart">configuration of the Helm-chart</a> it has to be installed into the Kubernetes cluster.
The installation is done with the following commands, which must be executed in the directory of the Helm-chart.</p>
</div>
<div class="listingblock">
<div class="title">Installation of the chart</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create namespace caas
helm install RELEASE_NAME . --namespace=caas --values /path/to/custom-values.yaml</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>The name of the release can be chosen freely.</p>
</div>
<div class="paragraph">
<p>If the namespace is to have a different name, you must replace the specifications within the commands accordingly.</p>
</div>
<div class="paragraph">
<p>If an already existing namespace is to be used, the creation is omitted and the desired namespace must be specified within the installation command.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Since the containers are first downloaded from the used image registry, the installation can take several minutes.
Ideally, however, a period of five minutes should not be exceeded before the CaaS platform is operational.</p>
</div>
<div class="paragraph">
<p>The status of each component can be obtained with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods --namespace=caas</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all components have the status <code>Running</code>, the installation is complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                 READY     STATUS        RESTARTS   AGE
caas-admin-webapp-1055845989-0s4pg   1/1       Running       0          5m
caas-mongo-0                         2/2       Running       0          4m
caas-mongo-1                         2/2       Running       0          3m
caas-mongo-2                         2/2       Running       0          1m
caas-rest-api-1851714254-13cvn       1/1       Running       0          5m
caas-rest-api-1851714254-13cvn       1/1       Running       0          4m
caas-rest-api-1851714254-xs6c0       1/1       Running       0          4m</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tls_kub"><a class="anchor" href="#tls_kub"></a>TLS</h3>
<div class="paragraph">
<p>The communication of the CaaS platform to the outside world is not encrypted by default.
If it is to be protected by TLS, there are two configuration options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Using an officially signed certificate</dt>
<dd>
<p>To use an officially signed certificate, a TLS secret is required, which must be generated first.
This must contain the keys <code>tls.key</code> and the certificate <code>tls.crt</code>.</p>
<div class="paragraph">
<p>The steps necessary to generate the TLS secret are described in the <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#tls"><em>Kubernetes Ingress Documentation</em></a>.</p>
</div>
</dd>
<dt class="hdlist1">Automated certificate management</dt>
<dd>
<p>As an alternative to using an officially signed certificate, it is possible to automate the administration using the cert manager.
This must be installed within the cluster and takes over the generation, distribution and updating of all required certificates.
The configuration of the Cert-Manager allows for example the use and automatic renewal of <a href="https://letsencrypt.org/">Let&#8217;s-Encrypt-Certificates</a>.</p>
<div class="paragraph">
<p>The necessary steps for installation are explained in the <a href="http://docs.cert-manager.io/en/latest/getting-started/index.html"><em>Cert-Manager-Documentation</em></a>.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_scaling"><a class="anchor" href="#_scaling"></a>Scaling</h3>
<div class="paragraph">
<p>In order to be able to quickly process the information transferred to CaaS, the CaaS platform must ensure optimal load distribution at all times.
For this reason, the REST Interface and the Mongo database are scalable and already configured to deploy at least three instances at a time for failover.
This minimum number of instances is mandatory, especially for the Mongo cluster.</p>
</div>
<div class="paragraph">
<p><strong>REST Interface</strong></p>
</div>
<div class="paragraph">
<p>The scaling of the REST Interface is done with the help of a <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#how-does-the-horizontal-pod-autoscaler-work">Horizontal Pod Autoscaler</a>.
Its activation as well as configuration must be done in the <code>custom-values.yaml</code> file to overwrite the default values defined in the <code>values.yaml</code> file.</p>
</div>
<div class="listingblock">
<div class="title">default configuration of the REST Interface</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">restApi:
Unresolved include directive in modules/CaaS_Platform/pages/CaaS_Platform_Documentation_EN.adoc - include::../../../../../caas-kubernetes/build/filtered/main/helm/caas/values.yaml[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Horizontal Pod Autoscaler allows to scale down or up the REST Interface depending on the current CPU load.
The parameter <code>targetCPUUtilizationPercentage</code> specifies the percentage value from which scaling should take place.
At the same time the parameters <code>minReplicas</code> and <code>maxReplicas</code> define the minimum and maximum number of possible REST Interfacen instances.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The threshold value for the CPU load should be chosen with care:<br>
If too low a percentage is selected, the REST Interface scales up too early in the case of increasing load.
If too high a percentage is selected, the REST Interface will not scale fast enough as the load increases.</p>
</div>
<div class="paragraph">
<p>A wrong configuration can therefore endanger the stability of the system.</p>
</div>
<div class="paragraph">
<p>The official <em>Kubernetes Horizontal Pod Autoscaler-documentation</em> as well as the <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough">examples listed</a> in it contain further information on the use of an Horizontal Pod Autoscaler.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="scaling_mongodb" class="paragraph">
<p><strong>Mongo database</strong></p>
</div>
<div class="paragraph">
<p>Unlike REST Interface, scaling the Mongo database is only possible manually.
Therefore, it cannot be performed automatically using a Horizontal Pod Autoscaler.</p>
</div>
<div class="paragraph">
<p>Scaling the Mongo database is done using the <code>replicas</code> parameter.
This parameter must be entered in the <a href="#conf_chart"><code>custom-values.yaml</code> file</a> to override the default value defined in the <code>values.yaml</code> file.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At least three instances are required to run the Mongo Cluster, otherwise there is no <code>Primary</code> node available and the database is not writable.
If the number of available instances falls below a value of 50% of the configured instances, no more <code>Primary</code> nodes can be selected.
However, this is essential for the functionality of the REST Interface.</p>
</div>
<div class="paragraph">
<p>The chapter <a href="https://docs.mongodb.com/manual/core/replica-set-architectures/#consider-fault-tolerance">Consider Fault Tolerance</a> of the <em>MongoDB documentation</em> describes how many nodes can explicitly fail,
until the determination of a new <code>Primary</code> node is impossible.
The information contained in the documentation must be taken into account when scaling the installation.</p>
</div>
<div class="paragraph">
<p>Further information on scaling and replicating the Mongo database is available in the chapters
<a href="https://docs.mongodb.com/manual/core/replica-set-architectures">Replica Set Deployment Architectures</a> and
<a href="https://docs.mongodb.com/manual/core/replica-set-elections">Replica Set Elections</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">definition of the replica parameter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">mongo:
Unresolved include directive in modules/CaaS_Platform/pages/CaaS_Platform_Documentation_EN.adoc - include::../../../../../caas-kubernetes/build/filtered/main/helm/caas/values.yaml[]</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A downscaling of the Mongo database is not possible without direct intervention and requires a manual reduction of the replicaset of the Mongo database.
The <a href="https://docs.mongodb.com/manual/tutorial/remove-replica-set-member/"><em>MongoDB documentation</em></a> describes the necessary steps for this.</p>
</div>
<div class="paragraph">
<p>Such intervention increases the risk of failure and is therefore not recommended.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Applying the configuration</strong></p>
</div>
<div class="paragraph">
<p>The updated <code>custom-values.yaml</code> file must be applied after the configuration changes for the REST Interface or Mongo database with the following command.</p>
</div>
<div class="listingblock">
<div class="title">upgrade command</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm upgrade -i RELEASE_NAME path/to/caas-&lt;VERSIONNUMBER&gt;.tgz --values /path/to/custom-values.yaml</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The release name can be determined with the command <code>helm list  --all-namespaces</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="monitoring"><a class="anchor" href="#monitoring"></a>Monitoring</h3>
<div class="paragraph">
<p>The CaaS platform is a micro service architecture and therefore consists of different components.
In order to be able to monitor its status properly at any time and to be able to react quickly in the event of an error, integration in a cluster-wide monitoring system is absolutely essential for operation with Kubernetes.</p>
</div>
<div class="paragraph">
<p>The CaaS platform is already preconfigured for monitoring with <a href="https://github.com/coreos/prometheus-operator">Prometheus Operator</a>, since this scenario is widely used in the Kubernetes environment.
It includes Prometheus ServiceMonitors for collecting metrics, Prometheus Alerts for notification in case of problems and predefined Grafana dashboards for visualizing the metrics.</p>
</div>
<div class="sect3">
<h4 id="_requirements"><a class="anchor" href="#_requirements"></a>Requirements</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is essential to set up monitoring and log persistence for the Kubernetes cluster.
Without these prerequisites, there are hardly any analysis possibilities in case of a failure and <a href="https://help.e-spirit.com">Technical Support</a> lacks important information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Metrics</dt>
<dd>
<p>To install the <a href="https://github.com/coreos/prometheus-operator">Prometheus Operator</a> please use the official <a href="https://github.com/helm/charts/tree/master/stable/prometheus-operator">Helm-Chart</a>, so that cluster monitoring can be set up based on it.
For further information please refer to the corresponding documentation.</p>
<div class="paragraph">
<p>If you are not running a Prometheus Operator, you must turn off the Prometheus ServiceMonitors and Prometheus Alerts.</p>
</div>
</dd>
<dt class="hdlist1">Logging</dt>
<dd>
<p>With the use of Kubernetes it is possible to provide various containers or services in an automated and scalable way.
To ensure that the logs remain in such a dynamic environment even after an instance has been terminated, an infrastructure must be integrated that persists the instance beforehand.</p>
<div class="paragraph">
<p>Therefore we recommend the use of a central logging system, such as <a href="https://www.elastic.co/elk-stack">Elastic-Stack</a>.
The Elastic or ELK stack is a collection of open source projects that help to persist, search and analyze log data in real time.</p>
</div>
<div class="paragraph">
<p>Here too, you can use an existing <a href="https://github.com/helm/charts/tree/master/stable/elastic-stack">Helm-Chart</a> for the installation.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="monitoring_servicemonitors"><a class="anchor" href="#monitoring_servicemonitors"></a>Prometheus ServiceMonitors</h4>
<div class="paragraph">
<p>The deployment of the ServiceMonitors provided by the CaaS platform for the REST Interface and the mongo database, is controlled via the <code>custom-values.yaml</code> file of the <a href="#conf_chart">Helm-Charts</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The access to the metrics of the REST Interface is secured by HTTP Basic Auth and the access to the metrics of the MongoDB by a corresponding MongoDB user.
The respective access data is contained in the credentials block of the <code>values.yaml</code> file of the <a href="#conf_chart">Helm-Charts</a>.</p>
</div>
<div class="paragraph">
<p>Please adjust the credentials in your <code>custom-values.yaml</code> file for security reasons.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Typically, Prometheus is configured to consider only ServiceMonitors with specific labels.
The labels can therefore be configured in the <code>custom-values.yaml</code> file and are valid for all ServiceMonitors of the CaaS Helm chart.
Furthermore, the parameter <code>scrapeInterval</code> allows a definition of the frequency with which the respective metrics are retrieved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">monitoring:
  prometheus:
Unresolved include directive in modules/CaaS_Platform/pages/CaaS_Platform_Documentation_EN.adoc - include::../../../../../caas-kubernetes/build/filtered/main/helm/caas/values.yaml[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The MongoDB metrics are provided via a sidecar container and retrieved with the help of a separate database user.
You can configure the database user in the <code>credentials</code> block of the <code>custom-values.yaml</code>.
The sidecar container is stored with the following standard configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">mongo:
Unresolved include directive in modules/CaaS_Platform/pages/CaaS_Platform_Documentation_EN.adoc - include::../../../../../caas-kubernetes/build/filtered/main/helm/caas/values.yaml[]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_prometheus_alerts"><a class="anchor" href="#_prometheus_alerts"></a>Prometheus Alerts</h4>
<div class="paragraph">
<p>The deployment of the alerts provided by the CaaS platform is controlled via the <code>custom-values.yaml</code> file of the <a href="#conf_chart">Helm-Charts</a>.</p>
</div>
<div class="paragraph">
<p>Prometheus is typically configured to consider only alerts with specific labels.
The labels can therefore be configured in the <code>custom-values.yaml</code> file and apply to all alerts in the CaaS Helm chart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">monitoring:
  prometheus:
Unresolved include directive in modules/CaaS_Platform/pages/CaaS_Platform_Documentation_EN.adoc - include::../../../../../caas-kubernetes/build/filtered/main/helm/caas/values.yaml[]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_grafana_dashboards"><a class="anchor" href="#_grafana_dashboards"></a>Grafana Dashboards</h4>
<div class="paragraph">
<p>The deployment of the Grafana dashboards provided by the CaaS platform is controlled via the <code>custom-values.yaml</code> file of the <a href="#conf_chart">Helm-Charts</a>.</p>
</div>
<div class="paragraph">
<p>Typically, the Grafana Sidecar Container is configured to consider only configmaps with specific labels and in a defined namespace.
The labels of the configmap and the namespace in which it is deployed can therefore be configured in the <code>custom-values.yaml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">monitoring:
Unresolved include directive in modules/CaaS_Platform/pages/CaaS_Platform_Documentation_EN.adoc - include::../../../../../caas-kubernetes/build/filtered/main/helm/caas/values.yaml[]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="development-environment"><a class="anchor" href="#development-environment"></a>Development Environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kubernetes and Helm form the basis of all CaaS platform installations.
In case of development environments we recommend installing CaaS platform into a separate namespace on your production cluster or any cluster configured similarly.
We do not recommend using local CaaS platform instances, even for development.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The documentation regarding deprecated Docker Compose stack was removed with version 7.1.0.
However, it is still available in the documentation of the previous versions up to and including <a href="https://docs.e-spirit.com/module/caas-platform/7.0.0/CaaS_Platform_Documentation_EN.html#development-environment">version 7.0.0</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you need a local environment on developer machines you have to create a local Kubernetes cluster to be used.
One of the following projects may be used to achieve this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://k3d.io/">k3d</a></p>
</li>
<li>
<p><a href="https://kind.sigs.k8s.io/">Kubernetes in Docker</a></p>
</li>
<li>
<p><a href="https://minikube.sigs.k8s.io/docs/">Minikube</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This list does not claim to be exhaustive.
Rather, it is intended to give some examples of which we know that operation is generally possible without us permanently using these projects ourselves.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each of these projects can be used to manage Kubernetes clusters locally.
However, we&#8217;re not able to give you support for any of these specific projects.
The CaaS platform uses only standard Helm and Kubernetes features and is thus independent of any particular Kubernetes distribution.</p>
</div>
<div class="paragraph">
<p>Please be sure to configure the following features correctly when using a local Kubernetes cluster:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kubernetes Image Pull Secrets to resolve the docker images from your local or company Docker registry</p>
</li>
<li>
<p>disabling monitoring features in <code>custom-values.yaml</code> or installing the needed prerequisites</p>
</li>
<li>
<p>tweaking host systems DNS settings to be able to work with Kubernetes Ingress resources or using local port forwards into the cluster</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rest_interface"><a class="anchor" href="#_rest_interface"></a>REST Interface</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_storage_of_the_content"><a class="anchor" href="#_storage_of_the_content"></a>Storage of the content</h3>
<div class="paragraph">
<p>Using the REST Interface all content can be managed via HTTP and is stored in CaaS in so-called collections, which are subordinate to databases.
The following three-part <a href="https://restheart.org/learn/resource-uri/">URL scheme</a> applies:</p>
</div>
<div class="paragraph">
<p><code>http://Servername:Port/Database/Collection/Document</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Binary content (media) is an exception in that it is stored in so-called buckets.
The associated collections always end with the suffix <code>.files</code>.</p>
</div>
<div class="paragraph">
<p><code>http://Servername:Port/Database/MediaCollection.files/Media</code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_authentication"><a class="anchor" href="#_authentication"></a>Authentication</h3>
<div class="paragraph">
<p>Each request to the REST Interface must be authenticated, otherwise it will be rejected.
The various authentication options are explained below.</p>
</div>
<div class="sect3">
<h4 id="_authentication_as_admin_user"><a class="anchor" href="#_authentication_as_admin_user"></a>Authentication as admin user</h4>
<div class="paragraph">
<p>Authorization of the admin user is done using HTTP Basic Authentication with the configured credentials. The admin user is intended for administrative tasks, such as the administration of API Keys.
All other operations should be authenticated using API Keys.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>API Keys control access rights to projects and can only be managed by the admin user.
See the <a href="#apikey_management">Management of API Keys</a> section for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>The credentials of the admin user are defined in the parameters <code>credentials.webAdminUser</code> and <code>credentials.webAdminPassword</code> of the Helm chart.</p>
</div>
<div class="paragraph">
<p>Details can be found in chapter <a href="#conf_chart_authentication">Authentication</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_authentication_with_api_keys"><a class="anchor" href="#_authentication_with_api_keys"></a>Authentication with API Keys</h4>
<div class="paragraph">
<p>Each request to the REST Interface must contain an HTTP header of the form <code>Authorization: apikey="&lt;key&gt;"</code>.
The value of <code>key</code> is expected to be the value of the <code>key</code> attribute of the corresponding API Key.</p>
</div>
<div class="paragraph">
<p>See the <a href="#apikey_validation">Validation of API Keys</a> section below for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_authentication_with_security_token"><a class="anchor" href="#_authentication_with_security_token"></a>Authentication with security token</h4>
<div class="paragraph">
<p>It is possible to generate a short-lived (up to 24 hours) security token for an API Key.
The token contains the same permissions as the API Key which it was generated for.
There are two ways to generate and use these tokens:</p>
</div>
<div class="sect4">
<h5 id="_query_parameter"><a class="anchor" href="#_query_parameter"></a>Query Parameter</h5>
<div class="paragraph">
<p>A GET request authenticated with an API Key to the <code>/_logic/securetoken?tenant=&lt;db&gt;</code> endpoint generates a security token.
Such a token can be issued only for one specified database, regardless of whether the API Key has permissions on multiple databases.
The parameter <code>&amp;ttl=&lt;lifetime in seconds&gt;</code> is optional.
The JSON response contains the security token.</p>
</div>
<div class="paragraph">
<p>Each request to the REST Interface can optionally be authenticated using a query parameter <code>?securetoken=&lt;token&gt;</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_cookie"><a class="anchor" href="#_cookie"></a>Cookie</h5>
<div class="paragraph">
<p>A GET request authenticated with an API Key to the <code>/_logic/securetokencookie?tenant=&lt;db&gt;</code> endpoint generates a security token cookie.
Such a cookie can be issued only for one specified database, regardless of whether the API Key has permissions on multiple databases.
The parameter <code>&amp;ttl=&lt;lifetime in seconds&gt;</code> is optional.
The response includes a <code>set-cookie</code> header with the security token.</p>
</div>
<div class="paragraph">
<p>All requests that include this cookie get automatically authenticated.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_authentication_order"><a class="anchor" href="#_authentication_order"></a>Authentication order</h4>
<div class="paragraph">
<p>If multiple authentication mechanisms are used at the same time in a request, only the first one will be evaluated.
The order is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>securetoken</code> query parameter.</p>
</li>
<li>
<p>The <code>Authorization</code> header.</p>
</li>
<li>
<p>The <code>securetoken</code> cookie.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="apikey_management"><a class="anchor" href="#apikey_management"></a>Management of API Keys</h3>
<div class="paragraph">
<p>API Keys, like all other resources in CaaS, can be managed via REST endpoints.
In general, it is important to distinguish that API Keys can be managed at two levels: global or local per database.
Global API Keys differ from local API Keys by their scope of validity.</p>
</div>
<div class="paragraph">
<p>When using an API Key for authentication, the CaaS platform always searches the local API Keys first.
If no matching API Key is found, the global API Keys are evaluated afterwards.</p>
</div>
<div class="sect3">
<h4 id="_global_api_keys"><a class="anchor" href="#_global_api_keys"></a>Global API Keys</h4>
<div class="paragraph">
<p>Global API Keys are cross-database and are managed in the <code>apikeys</code> collection of the <code>caas_admin</code> database.
Unlike local API Keys, they allow permissions to be defined for multiple or even all databases.</p>
</div>
</div>
<div class="sect3">
<h4 id="_local_api_keys"><a class="anchor" href="#_local_api_keys"></a>Local API Keys</h4>
<div class="paragraph">
<p>Local API Keys are defined per database and are managed accordingly in the <code>apikeys</code> collection of any database.
Unlike global API Keys, local API Keys can only define permissions for resources within the same database.</p>
</div>
</div>
<div class="sect3">
<h4 id="_authorization_model"><a class="anchor" href="#_authorization_model"></a>Authorization Model</h4>
<div class="paragraph">
<p>The authorization of an API Key is performed using its <code>url</code> attribute.
This value is checked against the URL path of the request.</p>
</div>
<div class="paragraph">
<p>This results in a basic distinction between global and local API Keys.
Global API Keys always check against the entire path of the request, while local API Keys only check against the part of the path after the database.</p>
</div>
<div class="paragraph">
<p>The following example illustrates this procedure:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. API Key authorization</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">authorization in API Key</th>
<th class="tableblock halign-left valign-top">type of API Key</th>
<th class="tableblock halign-left valign-top">request URL path</th>
<th class="tableblock halign-left valign-top">Allowed</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="5"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top" rowspan="5"><p class="tableblock">global</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/project/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/project/content/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/other-project/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/other-project/content/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="5"><p class="tableblock">/project/</p></td>
<td class="tableblock halign-left valign-top" rowspan="5"><p class="tableblock">global</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/project/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/project/content/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/other-project/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/other-project/content/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="5"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top" rowspan="5"><p class="tableblock">local in 'project</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/project/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/project/content/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/other-project/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/other-project/content/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="5"><p class="tableblock">/content/</p></td>
<td class="tableblock halign-left valign-top" rowspan="5"><p class="tableblock">local in 'project</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/project/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/project/content/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/other-project/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/other-project/content/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_rest_endpoints"><a class="anchor" href="#_rest_endpoints"></a>REST endpoints</h4>
<div class="paragraph">
<p>The following endpoints are available for managing API Keys:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since managing API Keys is considered part of administrative tasks, both read and write access are exclusive to the admin user.
To issue queries, please use a REST client of your choice.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>GET /&lt;database&gt;/apikeys</p>
</li>
<li>
<p>POST /&lt;database&gt;/apikeys<br>
<strong>Note:</strong> the parameters <code>_id</code> and <code>key</code> are mandatory and must have identical values</p>
</li>
<li>
<p>PUT /&lt;database&gt;/apikeys/{id}<br>
<strong>Note:</strong> the parameter <code>key</code> must have the same value as the {id} in the URL</p>
</li>
<li>
<p>DELETE /&lt;database&gt;/apikeys/{id}</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The database is based on the type of API Key.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>apikeys</code> collections are reserved for API Keys and cannot be used for normal content.
They are automatically added to existing databases along with a validation scheme when the application is started, and also created during runtime when databases are created/updated.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="apikey_validation"><a class="anchor" href="#apikey_validation"></a>Validation of API Keys</h4>
<div class="paragraph">
<p>Each API Key is validated against a stored JSON schema when created and updated.
The JSON schema secures the basic structure of API Keys and can be queried at <code>/&lt;database&gt;/_schemas/apikeys</code>.</p>
</div>
<div class="paragraph">
<p>Further validations ensure that no two API Keys can be created with the same <code>key</code>.
Likewise, a API Key must not contain a URL more than once.</p>
</div>
<div class="paragraph">
<p>If a API Key does not satisfy the requirements, the corresponding request is rejected with HTTP status 400.</p>
</div>
<div class="paragraph">
<p>If the JSON schema has not been successfully stored in the database before, requests are answered with HTTP status 500.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>key</code> attribute of a API Key should contain a valid UUID.
The format of a UUID is strictly specified by <a href="https://tools.ietf.org/html/rfc4122" class="bare">https://tools.ietf.org/html/rfc4122</a> [RFC 4122].
This includes, in particular, the presence of lowercase letters.
Although the CaaS platform does not currently validate this property, we reserve the right to enable this restriction in the future.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_managing_content"><a class="anchor" href="#_managing_content"></a>Managing content</h3>
<div class="sect3">
<h4 id="_hal_format"><a class="anchor" href="#_hal_format"></a>HAL format</h4>
<div class="paragraph">
<p>The interface returns all results in HAL format.
This means that they are not simply raw data, such as traditionally unstructured content in JSON format.</p>
</div>
<div class="paragraph">
<p>The HAL format offers the advantage of simple but powerful structuring.
In addition to the required content, the results contain additional meta-information on the structure of this content.</p>
</div>
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{ "_size": 5,
   "_total_pages": 1,
   "_returned": 3,
   "_embedded": { CONTENT }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example a filtered query was sent.
Without knowing the exact content, its structure can be read directly from the meta information.
At this point, the REST Interface returns three results from a set of five documents corresponding to the filter criteria and displays them on a single page.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the element to be requested is a medium, the URL only determines its metadata.
The HAL format contains corresponding links that refer to the URL with the actual binary content of the medium.
For further information please refer to the <a href="https://restheart.org/docs/files/">documentation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_page_size_of_queries"><a class="anchor" href="#_page_size_of_queries"></a>Page size of queries</h4>
<div class="paragraph">
<p>The results of REST Interface are always delivered paginated.
To control the page size and requested page, the HTTP query parameters <code>pagesize</code> and <code>page</code> can be used for GET requests.
For more information, see the <a href="https://restheart.org/docs/v3/query-documents/#paging"><em>RESTHeart documentation</em></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_of_filters"><a class="anchor" href="#_use_of_filters"></a>Use of filters</h4>
<div class="paragraph">
<p>Filters are always used when documents are not to be determined by their ID but by their content.
In this way, both single and multiple documents can be retrieved.</p>
</div>
<div class="paragraph">
<p>For example, the query of all English language documents from the <em>products</em> collection has the following structure:</p>
</div>
<div class="paragraph">
<p><code>http://Servername:Port/Database/products?filter={fs_language: "EN"}</code></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Beyond this example there are further filter possibilities.
For more information, see <a href="https://restheart.org/learn/query-documents/#filtering">query documentation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="indexes"><a class="anchor" href="#indexes"></a>Indexes for efficient query execution</h3>
<div class="paragraph">
<p>The runtime of queries with filters can get longer as the number of documents in a collection grows.
If it exceeds a certain value, the query is answered by the REST Interface with HTTP status 408.
More efficient execution can be achieved by creating an index on the attributes used in the affected filter queries.</p>
</div>
<div class="paragraph">
<p>For detailed information on database indices, please refer to the documentation of the <a href="https://docs.mongodb.com/manual/indexes/">MongoDB</a>.</p>
</div>
<div class="sect3">
<h4 id="_predefined_indexes"><a class="anchor" href="#_predefined_indexes"></a>Predefined indexes</h4>
<div class="paragraph">
<p>If you have CaaS Connect in use, predefined indices are already created that support some frequently used filter queries.
The exact definitions can be found at <code>http://Servername:Port/Database/Collection/_indexes/</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_customer_specific_indexes"><a class="anchor" href="#_customer_specific_indexes"></a>Customer-specific indexes</h4>
<div class="paragraph">
<p>If the predefined indices do not cover your use cases and you observe long response times or even request timeouts, you can create your own indexes.
The REST Interface can be used to manage the desired indexes.
The procedure is described in the <a href="https://restheart.org/docs/mgmt/indexes/">RESTheart documentation</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Please only create the indexes you need.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_push_notifications_change_streams"><a class="anchor" href="#_push_notifications_change_streams"></a>Push notifications (change streams)</h3>
<div class="paragraph">
<p>It is often convenient to be notified about changes in the CaaS platform.
For this purpose the CaaS platform offers change streams.
This feature allows a websocket connection to be established to the CaaS platform, through which events about the various changes are published.</p>
</div>
<div class="paragraph">
<p>Change streams are created by putting a definition in the metadata of a collection.
If you use CaaS Connect, a number of predefined change streams are already created for you.
You also have the option to define <a href="https://restheart.org/docs/change-streams/">your own change streams</a>.</p>
</div>
<div class="paragraph">
<p>The format of the events corresponds to <a href="https://docs.mongodb.com/manual/reference/change-events/">standard MongoDB events</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When working with websockets, we recommend taking into account connection failures that may occur.
Regular <code>ping</code> messages and a mechanism for automatic connection recovery should be included in your implementation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can find an example of using change streams in the browser <a href="#cs_example">in the appendix</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="metrics_overview"><a class="anchor" href="#metrics_overview"></a>Metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Metrics are used for monitoring and error analysis of CaaS components during operation and can be accessed via HTTP endpoints.
If metrics are available in Prometheus format, corresponding ServiceMonitors are generated for this purpose, see also <a href="#monitoring_servicemonitors">Prometheus ServiceMonitors</a>.</p>
</div>
<div class="sect2">
<h3 id="_rest_interface_2"><a class="anchor" href="#_rest_interface_2"></a>REST Interface</h3>
<div class="paragraph">
<p><strong>Healthcheck</strong></p>
</div>
<div class="paragraph">
<p>The Healthcheck endpoint provides information about the functionality of the corresponding component in the form of a JSON document.
This status is calculated from several checks.
If all checks are successful, the JSON response has the HTTP status 200.
As soon as at least one check has the value <code>false</code>, the response has HTTP status 500.</p>
</div>
<div class="paragraph">
<p>The query is made using the URL: <code>\\http://REST-HOST:PORT/_logic/healthcheck</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The functionality of the REST Interface depends on the accessibility of the MongoDB cluster as well as on the existence of a primary node.
If the cluster does not have a primary node, it is not possible to perform write operations on the MongoDB.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>HTTP Metrics</strong></p>
</div>
<div class="paragraph">
<p>Metrics for HTTP requests and responses of the REST Interface can be retrieved as a JSON document or in Prometheus format at the following URL
<code>http://REST-HOST:PORT/_metrics</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Further information is available in the <a href="https://restheart.org/learn/requests-metrics/"><em>RESTHeart-Documentation</em></a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_mongodb"><a class="anchor" href="#_mongodb"></a>MongoDB</h3>
<div class="paragraph">
<p>The metrics of the MongoDB are provided by a sidecar container.
This container accesses the MongoDB metrics with a separate database user and provides them via HTTP.</p>
</div>
<div class="paragraph">
<p>The metrics can be accessed at the following URL: <code>http://MONGODB-HOST:METRICS-PORT/metrics</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Please note that the MongoDB metrics are delivered via a separate port.
This port is not accessible from outside the cluster and therefore not protected by authentication.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_maintenance"><a class="anchor" href="#_maintenance"></a>Maintenance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The transfer of data to CaaS can only work if the individual components work properly.
If faults occur or an update is necessary, all CaaS components must therefore be considered.
The following subchapters describe the necessary steps of an error analysis in case of a malfunction and the execution of a backup or update.</p>
</div>
<div class="sect2">
<h3 id="_error_analysis"><a class="anchor" href="#_error_analysis"></a>Error analysis</h3>
<div class="paragraph">
<p>CaaS is a distributed system and is based on the interaction of different components.
Each of these components can potentially generate errors.
Therefore, if a failure occurs while using CaaS, it can have several causes.
The basic analysis steps for determining the causes of faults are explained below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Status of the components</dt>
<dd>
<p>The status of each component of the CaaS platform can be checked using the <code>kubectl get pods --namespace=&lt;namespace&gt;</code> command.
If the status of an instance differs from <code>running</code> or <code>ready</code>, it is recommended to start debugging at this point and check the associated log files.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If there are problems with the <a href="#scaling_mongodb">Mongo database</a>, check whether a <code>Primary</code> node exists.
If the number of available instances falls below 50% of the configured instances, no more Primary nodes can be selected.
However, this is essential for the functionality of the REST Interface.
The absence of a <code>Primary</code> node means that the pods of the REST Interface no longer have the status <code>ready</code> and are therefore unreachable.</p>
</div>
<div class="paragraph">
<p>The chapter <a href="https://docs.mongodb.com/manual/core/replica-set-architectures/#consider-fault-tolerance">Consider Fault Tolerance</a> of the <em>MongoDB documentation</em> describes how to avoid this,
how many nodes can explicitly fail until the determination of a new <code>primary</code> node is impossible</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Analysis of the logs</dt>
<dd>
<p>In case of problems, the log files are a good starting point for analysis.
They offer the possibility to trace all processes on the systems.
In this way, any errors and warnings become apparent.</p>
<div class="paragraph">
<p>Current log files of the CaaS components can be viewed using <code>kubectl --namespace=&lt;namespace&gt; logs &lt;pod&gt;</code>, but only contain events that occurred within the lifetime of the current instance.
To be able to analyze the log files after a crash or restart of an instance, we recommend setting up a central logging system.</p>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The log files can only be viewed for the currently running container.
For this reason, it is necessary to set up a persistent storage to access the log files of already finished or newly started containers.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="backup"><a class="anchor" href="#backup"></a>Backup</h3>
<div class="paragraph">
<p>The architecture of CaaS consists of different, independent components that generate and process different information.
If there is a need for data backup, this must therefore be done depending on the respective component.</p>
</div>
<div class="paragraph">
<p>A backup of the information stored in CaaS must be performed using the standard mechanisms of the Mongo database.
This can either be done by creating a <a href="https://docs.mongodb.com/manual/core/backups/#back-up-by-copying-underlying-data-files">copy of the underlying files</a> or by using <a href="https://docs.mongodb.com/manual/core/backups/#back-up-with-mongodump"><code>mongodump</code></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="update"><a class="anchor" href="#update"></a>Update</h3>
<div class="paragraph">
<p>Operating the CaaS platform with Helm in Kubernetes provides the possibility of updating to the new version without the need for a new installation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before updating the Mongo database, a <a href="#backup">Backup</a> is strongly recommended.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>helm list --all-namespaces</code> command first returns a list of all already installed Helm charts.
This list contains both the version and the namespace of the corresponding release.</p>
</div>
<div class="listingblock">
<div class="title">sample list of installed releases</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">\$ helm list --all-namespaces
NAME            NAMESPACE    REVISION  UPDATED             STATUS    CHART        APP VERSION
firstinstance   integration  1         2019-12-11 15:51..  DEPLOYED  caas-2.10.4  caas-2.10.4
secondinstance  staging      1         2019-12-12 09:31..  DEPLOYED  caas-2.10.4  caas-2.10.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>To update a release, the following steps must be carried out one after the other:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Transfer the settings</dt>
<dd>
<p>To avoid losing the previous settings, it is necessary to have the <code>custom-values.yaml</code> file with which the initial installation of the Helm chart was carried out.</p>
</dd>
<dt class="hdlist1">Adoption of further adjustments</dt>
<dd>
<p>If there are adjustments to files (e.g. in the <code><strong>config</strong></code> directory), these must also be adopted.</p>
</dd>
<dt class="hdlist1">Update</dt>
<dd>
<p>After performing the previous steps, the update can be started.
It replaces the existing installation with the new version without any downtime.
To do this, execute the following command, which starts the process:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm upgrade RELEASE_NAME caas-{build-version}.tgz --values /path/to/custom-values.yaml</code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix"><a class="anchor" href="#_appendix"></a>Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_examples"><a class="anchor" href="#_examples"></a>Examples</h3>
<div id="cs_example" class="listingblock">
<div class="title">Usage of change streams with Javascript and Browser API</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;script type="module"&gt;
  import PersistentWebSocket from 'https://cdn.jsdelivr.net/npm/pws@5/dist/index.esm.min.js';

  // Replace this with your API key (needs read access for the preview collection)
  const apiKey = "your-api-key";

  // Replace this with your preview collection url (if not known copy from CaaS Connect Project App)
  // e.g. "https://caas-host/my-tenant-id/f948bb48-4f6b-4a8a-b521-338c9d352f2b.preview.content"
  const previewCollectionUrl = new URL("your-preview-collection-url");

  const pathSegments = previewCollectionUrl.pathname.split("/");
  if (pathSegments.length !== 3) {
    throw new Error(`The format of the provided url '${previewCollectionUrl}' is incorrect and should only contain two path segments`);
  }

  (async function(){
    // Retrieving temporary auth token
    const token = await fetch(new URL(`_logic/securetoken?tenant=${pathSegments[1]}`, previewCollectionUrl.origin).href, {
      headers: {'Authorization': `apikey="${apiKey}"`}
    }).then((response) =&gt; response.json()).then((token) =&gt; token.securetoken).catch(console.error);

    // Establishing WebSocket connection to the change stream "crud"
    // ("crud" is the default change stream that the CaaS Connect module provides)
    const wsUrl = `wss://${previewCollectionUrl.host + previewCollectionUrl.pathname}`
      + `/_streams/crud?securetoken=${token}`;
    const pws = new PersistentWebSocket(wsUrl, { pingTimeout: 60000 });

    // Handling change events
    pws.onmessage = event =&gt; {
      const {
        documentKey: {_id: documentId},
        operationType: changeType,
      } = JSON.parse(event.data);
      console.log(`Received event for '${documentId}' with change type '${changeType}'`);
    }
  })();
&lt;/script&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
